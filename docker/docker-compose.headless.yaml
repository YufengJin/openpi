# Headless mode: no GUI, for training / policy serving / testing.
#
# Usage:
#   docker compose -f docker/docker-compose.headless.yaml up --build      # start
#   docker exec -it openpi-dev-headless bash                               # shell
#   docker compose -f docker/docker-compose.headless.yaml run --rm openpi-dev --verify  # env test
#   docker compose -f docker/docker-compose.headless.yaml --profile test run --rm verify-env  # one-shot test

services:
  openpi-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: openpi:latest
    container_name: openpi-headless

    restart: unless-stopped

    tty: true
    stdin_open: true

    environment:
      - PYTHONUNBUFFERED=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - OPENPI_DATA_HOME=/openpi_assets
      - IS_DOCKER=true

    volumes:
      - ..:/app
      - ${OPENPI_DATA_HOME:-~/.cache/openpi}:/openpi_assets

    network_mode: host
    ipc: host
    pid: host

    command: tail -f /dev/null

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc: 65536
      memlock: -1
      stack: 67108864

  # One-shot environment verification (docker compose --profile test run --rm verify-env)
  verify-env:
    extends:
      service: openpi-dev
    container_name: openpi-verify-env
    profiles: ["test"]
    restart: "no"
    command: ["--verify"]
